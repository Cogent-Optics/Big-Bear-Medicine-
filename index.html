+86
-614
Lines changed: 86 additions & 614 deletions
Original file line number	Diff line number	Diff line change
@@ -1,507 +1,4 @@
<script>
        // Global variables
        let currentYear = 2025;
        let scheduleData = {};
        let members = [];
        let pendingAction = null;
        let currentUser = '';
        let unsubscribeListeners = [];
        let firebaseInitialized = false;
        // Authentication functions
        function joinCircle() {
            try {
                console.log('Join circle clicked');
                const input = document.getElementById('userNameInput');
                const name = input?.value?.trim();
                
                console.log('Name entered:', name);
                
                if (name && name.length >= 2) {
                    currentUser = name;
                    localStorage.setItem('bearCircleUser', name);
                    console.log('User set:', currentUser);
                    showMainApp();
                } else {
                    alert('Please enter your full name (at least 2 characters)');
                }
            } catch (error) {
                console.error('Error in joinCircle:', error);
                alert('Login error. Please refresh the page and try again.');
            }
        }
        function logout() {
            // Clean up listeners
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
            
            localStorage.removeItem('bearCircleUser');
            currentUser = '';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userNameInput').value = '';
        }
        function showMainApp() {
            try {
                console.log('Showing main app for user:', currentUser);
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUserName').textContent = currentUser;
                
                // Initialize Firebase listeners if Firebase is ready
                if (firebaseInitialized && window.db) {
                    console.log('Firebase ready, initializing listeners');
                    initializeFirebaseListeners();
                } else {
                    console.log('Firebase not ready yet, will initialize listeners when ready');
                    // Generate basic schedule without Firebase data
                    generateSchedule();
                }
                
                console.log('Main app displayed successfully');
            } catch (error) {
                console.error('Error in showMainApp:', error);
                alert('Error loading application. Please refresh and try again.');
            }
        }
        async function addUserToMembers() {
            try {
                if (!members.includes(currentUser)) {
                    console.log('Adding user to members:', currentUser);
                    const updatedMembers = [...members, currentUser];
                    await saveToFirebase('members', { 
                        list: updatedMembers,
                        addedBy: currentUser,
                        dateAdded: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error adding user to members:', error);
            }
        }
        function updateSyncStatus(connected) {
            const statusElement = document.getElementById('syncStatus');
            if (connected) {
                statusElement.className = 'sync-status sync-connected';
                statusElement.innerHTML = 'ðŸŒ™ Connected to sacred circle - Real-time sync active';
            } else {
                statusElement.className = 'sync-status sync-disconnected';
                statusElement.innerHTML = 'âš ï¸ Connection lost - Check internet connection';
            }
        }
        async function saveToFirebase(docId, data) {
            if (!firebaseInitialized || !window.db) {
                console.log('Firebase not available, saving locally only');
                return;
            }
            
            try {
                // Add security metadata
                const secureData = {
                    ...data,
                    lastModifiedBy: currentUser,
                    lastModified: new Date().toISOString()
                };
                
                console.log('Saving to Firebase:', docId, secureData);
                
                await window.firestore.setDoc(
                    window.firestore.doc(window.db, 'bearCircle', String(docId)),
                    secureData,
                    { merge: true }
                );
                
                console.log('Successfully saved to Firebase');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                alert('Connection error. Please check your internet and try again.');
            }
        }
        async function saveScheduleData(cardId, data) {
            try {
                // Save the specific card data to Firebase
                await window.firestore.setDoc(
                    window.firestore.doc(window.db, 'bearCircle', `schedule-${currentYear}`),
                    { [cardId]: data },
                    { merge: true }
                );
                console.log(`Saved ${cardId} data:`, data);
            } catch (error) {
                console.error('Error saving schedule data:', error);
                alert('Connection error. Please check your internet and try again.');
            }
        }
        async function updateFirebaseField(docId, field, value) {
            try {
                const docRef = window.firestore.doc(window.db, 'bearCircle', String(docId));
                await window.firestore.updateDoc(docRef, {
                    [field]: value,
                    lastModifiedBy: currentUser,
                    lastModified: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error updating Firebase:', error);
            }
        }
        // Member management
        async function addMember() {
            const input = document.getElementById('newMemberName');
            const name = input.value.trim();
            
            if (name && !members.includes(name)) {
                const updatedMembers = [...members, name];
                await saveToFirebase('members', { 
                    list: updatedMembers,
                    addedBy: currentUser,
                    dateAdded: new Date().toISOString()
                });
                input.value = '';
            }
        }
        async function removeMember(name) {
            // Don't allow removing yourself
            if (name === currentUser) {
                alert('You cannot remove yourself from the sacred circle.');
                return;
            }
            
            const updatedMembers = members.filter(m => m !== name);
            await saveToFirebase('members', { 
                list: updatedMembers,
                removedBy: currentUser,
                dateRemoved: new Date().toISOString()
            });
        }
        function updateMembersList() {
            const container = document.getElementById('membersList');
            container.innerHTML = members.map(member => 
                `<span class="member-tag">
                    ${member}
                    <button class="remove-btn" onclick="removeMember('${member}')">Ã—</button>
                </span>`
            ).join('');
        }
        // New moon date calculations
        function getNewMoonDates(year) {
            const knownNewMoons2025 = [
                new Date(2025, 0, 29),  // January 29
                new Date(2025, 1, 28),  // February 28
                new Date(2025, 2, 29),  // March 29
                new Date(2025, 3, 27),  // April 27
                new Date(2025, 4, 27),  // May 27
                new Date(2025, 5, 25),  // June 25
                new Date(2025, 6, 24),  // July 24
                new Date(2025, 7, 23),  // August 23
                new Date(2025, 8, 21),  // September 21
                new Date(2025, 9, 21),  // October 21
                new Date(2025, 10, 20), // November 20
                new Date(2025, 11, 19)  // December 19
            ];
            if (year === 2025) {
                return knownNewMoons2025;
            }
            // Approximation for other years
            const baseDate = new Date(year, 0, 6);
            const lunarCycle = 29.53 * 24 * 60 * 60 * 1000;
            const newMoons = [];
            
            for (let i = 0; i < 13; i++) {
                const moonDate = new Date(baseDate.getTime() + (i * lunarCycle));
                if (moonDate.getFullYear() === year) {
                    newMoons.push(moonDate);
                }
            }
            
            return newMoons.filter(date => date.getFullYear() === year);
        }
        function getFiveDayWindow(newMoonDate) {
            const dates = [];
            for (let i = -2; i <= 2; i++) {
                const date = new Date(newMoonDate);
                date.setDate(date.getDate() + i);
                dates.push({
                    date: date,
                    label: i === -2 ? '2 Days Before' : 
                           i === -1 ? '1 Day Before' : 
                           i === 0 ? 'New Moon' : 
                           i === 1 ? '1 Day After' : 
                           '2 Days After',
                    isNewMoon: i === 0
                });
            }
            return dates;
        }
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }
        function formatLongDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        // Updated function to calculate day attendance colors
        function calculateDayAttendanceStatus(cardId, dayIndex) {
            const data = scheduleData[cardId] || {};
            const attendance = data.attendance || {};
            
            let yesCount = 0;
            let yesOrMaybeCount = 0;
            
            Object.values(attendance).forEach(memberDays => {
                if (typeof memberDays === 'object' && memberDays[dayIndex]) {
                    const status = memberDays[dayIndex];
                    if (status === 'yes') {
                        yesCount++;
                        yesOrMaybeCount++;
                    } else if (status === 'maybe') {
                        yesOrMaybeCount++;
                    }
                }
            });
            
            console.log(`Day ${dayIndex}: Yes=${yesCount}, Yes+Maybe=${yesOrMaybeCount}`);
            
            // Green: 4+ people with "yes"
            if (yesCount >= 4) {
                return 'green';
            }
            // Purple: 4+ people with "yes" OR "maybe" (but less than 4 "yes")
            else if (yesOrMaybeCount >= 4) {
                return 'purple';
            }
            // Orange: Less than 4 people with "yes" OR "maybe"
            else {
                return 'orange';
            }
        }
        // Updated function to get eligible members for role assignment
        function getEligibleMembersForDay(cardId, dayIndex) {
            const data = scheduleData[cardId] || {};
            const attendance = data.attendance || {};
            const eligible = [];
            
            Object.entries(attendance).forEach(([member, memberDays]) => {
                if (typeof memberDays === 'object' && memberDays[dayIndex] === 'yes') {
                    eligible.push(member);
                }
            });
            
            return eligible;
        }
        // Confirmation modal functions
        function showConfirmation(title, message, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmationModal').style.display = 'flex';
            pendingAction = action;
        }
        function hideConfirmation() {
            document.getElementById('confirmationModal').style.display = 'none';
            pendingAction = null;
        }
        function executeConfirmedAction() {
            if (pendingAction) {
                pendingAction();
                hideConfirmation();
            }
        }
        function showRandomizeConfirmation(cardId) {
            showConfirmation(
                'Randomize Roles',
                'This will randomly assign host and discussion leader roles from members who said "Yes" on the selected gathering date. Continue?',
                () => randomizeRoles(cardId)
            );
        }
        function showRandomizeAllConfirmation() {
            showConfirmation(
                'Randomize All Roles',
                'This will randomly assign host and discussion leader roles for ALL moon gatherings based on each day\'s "Yes" responses. Continue?',
                () => randomizeAllRoles()
            );
        }
        // Updated role assignment functions
        async function randomizeRoles(cardId) {
            const data = scheduleData[cardId] || {};
            const selectedDate = data.selectedDate;
            
            if (selectedDate === undefined) {
                alert('Please select a gathering date first.');
                return;
            }
            
            const eligibleMembers = getEligibleMembersForDay(cardId, selectedDate);
            
            if (eligibleMembers.length < 2) {
                alert(`Not enough members confirmed "Yes" for the selected date. Need at least 2, but only ${eligibleMembers.length} confirmed.`);
                return;
            }
            
            const shuffled = [...eligibleMembers].sort(() => Math.random() - 0.5);
            data.host = shuffled[0];
            data.leader = shuffled[1] !== shuffled[0] ? shuffled[1] : (shuffled[2] || shuffled[0]);
            
            // Update local data immediately
            scheduleData[cardId] = data;
            
            // Save to Firebase
            await saveScheduleData(cardId, data);
        }
        async function randomizeAllRoles() {
            const newMoons = getNewMoonDates(currentYear);
            let assignedCount = 0;
            let skippedCount = 0;
            
            for (let index = 0; index < newMoons.length; index++) {
                const cardId = `moon-${currentYear}-${index}`;
                const data = scheduleData[cardId] || {};
                const selectedDate = data.selectedDate;
                
                if (selectedDate === undefined) {
                    skippedCount++;
                    continue;
                }
                
                const eligibleMembers = getEligibleMembersForDay(cardId, selectedDate);
                
                if (eligibleMembers.length < 2) {
                    skippedCount++;
                    continue;
                }
                
                const shuffled = [...eligibleMembers].sort(() => Math.random() - 0.5);
                data.host = shuffled[0];
                data.leader = shuffled[1] !== shuffled[0] ? shuffled[1] : (shuffled[2] || shuffled[0]);
                
                // Update local data immediately
                scheduleData[cardId] = data;
                
                // Save to Firebase
                await saveScheduleData(cardId, data);
                assignedCount++;
            }
            
            alert(`Roles assigned for ${assignedCount} gatherings. ${skippedCount} gatherings skipped due to no selected date or insufficient "Yes" responses.`);
        }
        // Updated attendance functions
        async function updateDayStatus(cardId, member, dayIndex, status) {
            const data = scheduleData[cardId] || {};
            if (!data.attendance) data.attendance = {};
            if (!data.attendance[member]) data.attendance[member] = {};
            
            data.attendance[member][dayIndex] = status;
            
            // Update local data immediately
            scheduleData[cardId] = data;
            
            // Save to Firebase with correct structure
            await saveScheduleData(cardId, data);
            
            // Update UI immediately
            updateAttendanceDisplay(cardId);
        }
        function updateCardSelections(cardId) {
            const data = scheduleData[cardId] || {};
            const card = document.querySelector(`[data-card="${cardId}"]`);
            
            if (!card) return;
            
            // Update selected date
            const dateOptions = card.querySelectorAll('.date-option');
            dateOptions.forEach((option, index) => {
                if (data.selectedDate === index) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Update role selectors
            const hostSelector = card.querySelector('.host-selector');
            const leaderSelector = card.querySelector('.leader-selector');
            
            if (hostSelector && data.host) {
                hostSelector.value = data.host;
            }
            if (leaderSelector && data.leader) {
                leaderSelector.value = data.leader;
            }
            
            // Update meeting info fields
            const timeInput = card.querySelector('input[type="time"]');
            const locationInput = card.querySelector('.meeting-location input');
            const notesTextarea = card.querySelector('.meeting-notes textarea');
            
            if (timeInput && data.time) {
                timeInput.value = data.time;
            }
            if (locationInput && data.location) {
                locationInput.value = data.location;
            }
            if (notesTextarea && data.notes) {
                notesTextarea.value = data.notes;
            }
            
            // Update attendance dropdowns
            const attendance = data.attendance || {};
            Object.entries(attendance).forEach(([member, memberDays]) => {
                if (typeof memberDays === 'object') {
                    Object.entries(memberDays).forEach(([dayIndex, status]) => {
                        const dropdown = card.querySelector(`select[onchange*="'${member}', ${dayIndex}"]`);
                        if (dropdown) {
                            dropdown.value = status;
                            dropdown.className = `day-status-select status-${status}`;
                        }
                    });
                }
            });
        }
        function updateAttendanceDisplay(cardId) {
            const data = scheduleData[cardId] || {};
            const attendance = data.attendance || {};
            
            console.log(`Updating attendance display for ${cardId}:`, attendance);
            
            // Count members who said yes to any day
            const membersAttending = Object.values(attendance).filter(memberDays => {
                if (typeof memberDays === 'object') {
                    return Object.values(memberDays).some(status => status === 'yes');
                <!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
@@ -1306,59 +803,21 @@ <h3 id="modalTitle">Confirm Action</h3>
    </div>

    <script>
        // Global variables
        let currentYear = 2025;
        let scheduleData = {};
        let members = [];
        let pendingAction = null;
        let currentUser = '';
        let unsubscribeListeners = [];
        // Initialize application
        function initializeMainApp() {
            try {
                console.log('Initializing main app...');
                
                // Check if user is already logged in
                const savedUser = localStorage.getItem('bearCircleUser');
                console.log('Saved user:', savedUser);
                
                if (savedUser) {
                    currentUser = savedUser;
                    showMainApp();
                } else {
                    console.log('No saved user, showing login screen');
                    // Make sure login screen is visible
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }
        // Make functions globally available
        window.joinCircle = joinCircle;
        window.logout = logout;
        window.addMember = addMember;
        window.removeMember = removeMember;
        window.changeYear = changeYear;
        window.showRandomizeAllConfirmation = showRandomizeAllConfirmation;
        window.showRandomizeConfirmation = showRandomizeConfirmation;
        window.hideConfirmation = hideConfirmation;
        window.executeConfirmedAction = executeConfirmedAction;
        window.selectDate = selectDate;
        window.updateRole = updateRole;
        window.saveDataField = saveDataField;
        window.updateDayStatus = updateDayStatus;
        window.exportSchedule = exportSchedule;
        let firebaseInitialized = false;

        // Authentication functions
        function joinCircle() {
            try {
                console.log('Join circle clicked');
                const input = document.getElementById('userNameInput');
                const name = input.value.trim();
                const name = input?.value?.trim();

                console.log('Name entered:', name);

@@ -1573,19 +1032,6 @@ <h3 id="modalTitle">Confirm Action</h3>
            }
        }

        async function updateFirebaseField(docId, field, value) {
            try {
                const docRef = window.firestore.doc(window.db, 'bearCircle', String(docId));
                await window.firestore.updateDoc(docRef, {
                    [field]: value,
                    lastModifiedBy: currentUser,
                    lastModified: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error updating Firebase:', error);
            }
        }
        // Member management
        async function addMember() {
            const input = document.getElementById('newMemberName');
@@ -1868,62 +1314,7 @@ <h3 id="modalTitle">Confirm Action</h3>
            updateAttendanceDisplay(cardId);
        }

        function updateCardSelections(cardId) {
            const data = scheduleData[cardId] || {};
            const card = document.querySelector(`[data-card="${cardId}"]`);
            
            if (!card) return;
            
            // Update selected date
            const dateOptions = card.querySelectorAll('.date-option');
            dateOptions.forEach((option, index) => {
                if (data.selectedDate === index) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Update role selectors
            const hostSelector = card.querySelector('.host-selector');
            const leaderSelector = card.querySelector('.leader-selector');
            
            if (hostSelector && data.host) {
                hostSelector.value = data.host;
            }
            if (leaderSelector && data.leader) {
                leaderSelector.value = data.leader;
            }
            
            // Update meeting info fields
            const timeInput = card.querySelector('input[type="time"]');
            const locationInput = card.querySelector('.meeting-location input');
            const notesTextarea = card.querySelector('.meeting-notes textarea');
            
            if (timeInput && data.time) {
                timeInput.value = data.time;
            }
            if (locationInput && data.location) {
                locationInput.value = data.location;
            }
            if (notesTextarea && data.notes) {
                notesTextarea.value = data.notes;
            }
            
            // Update attendance dropdowns
            const attendance = data.attendance || {};
            Object.entries(attendance).forEach(([member, memberDays]) => {
                if (typeof memberDays === 'object') {
                    Object.entries(memberDays).forEach(([dayIndex, status]) => {
                        const dropdown = card.querySelector(`select[onchange*="'${member}', ${dayIndex}"]`);
                        if (dropdown) {
                            dropdown.value = status;
                            dropdown.className = `day-status-select status-${status}`;
                        }
                    });
                }
            });
        }
        function updateAttendanceDisplay(cardId) {
            const data = scheduleData[cardId] || {};
            const attendance = data.attendance || {};

@@ -1984,6 +1375,63 @@ <h3 id="modalTitle">Confirm Action</h3>
            await saveScheduleData(cardId, data);
        }

        function updateCardSelections(cardId) {
            const data = scheduleData[cardId] || {};
            const card = document.querySelector(`[data-card="${cardId}"]`);
            
            if (!card) return;
            
            // Update selected date
            const dateOptions = card.querySelectorAll('.date-option');
            dateOptions.forEach((option, index) => {
                if (data.selectedDate === index) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Update role selectors
            const hostSelector = card.querySelector('.host-selector');
            const leaderSelector = card.querySelector('.leader-selector');
            
            if (hostSelector && data.host) {
                hostSelector.value = data.host;
            }
            if (leaderSelector && data.leader) {
                leaderSelector.value = data.leader;
            }
            
            // Update meeting info fields
            const timeInput = card.querySelector('input[type="time"]');
            const locationInput = card.querySelector('.meeting-location input');
            const notesTextarea = card.querySelector('.meeting-notes textarea');
            
            if (timeInput && data.time) {
                timeInput.value = data.time;
            }
            if (locationInput && data.location) {
                locationInput.value = data.location;
            }
            if (notesTextarea && data.notes) {
                notesTextarea.value = data.notes;
            }
            
            // Update attendance dropdowns
            const attendance = data.attendance || {};
            Object.entries(attendance).forEach(([member, memberDays]) => {
                if (typeof memberDays === 'object') {
                    Object.entries(memberDays).forEach(([dayIndex, status]) => {
                        const dropdown = card.querySelector(`select[onchange*="'${member}', ${dayIndex}"]`);
                        if (dropdown) {
                            dropdown.value = status;
                            dropdown.className = `day-status-select status-${status}`;
                        }
                    });
                }
            });
        }
        // Schedule generation
        function generateSchedule() {
            const newMoons = getNewMoonDates(currentYear);
@@ -2227,6 +1675,30 @@ <h3 id="modalTitle">Confirm Action</h3>
            URL.revokeObjectURL(url);
        }

        // Initialize application
        function initializeMainApp() {
            try {
                console.log('Initializing main app...');
                
                // Check if user is already logged in
                const savedUser = localStorage.getItem('bearCircleUser');
                console.log('Saved user:', savedUser);
                
                if (savedUser) {
                    currentUser = savedUser;
                    showMainApp();
                } else {
                    console.log('No saved user, showing login screen');
                    // Make sure login screen is visible
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }
        // Set up confirmation modal
        document.getElementById('confirmBtn').onclick = executeConfirmedAction;
